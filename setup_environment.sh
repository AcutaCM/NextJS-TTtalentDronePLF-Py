#!/bin/bash
# æ— äººæœºæ™ºèƒ½åˆ†æžå¹³å° - ä¸€é”®çŽ¯å¢ƒé…ç½®è„šæœ¬ (Linux/Mac)

set -e  # é‡åˆ°é”™è¯¯æ—¶åœæ­¢æ‰§è¡Œ

echo "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              æ— äººæœºæ™ºèƒ½åˆ†æžå¹³å° - ä¸€é”®çŽ¯å¢ƒé…ç½®               â•‘
â•‘                                                              â•‘
â•‘  æ­¤è„šæœ¬å°†è‡ªåŠ¨é…ç½®é¡¹ç›®æ‰€éœ€çš„æ‰€æœ‰çŽ¯å¢ƒ                          â•‘
â•‘  åŒ…æ‹¬: Node.jsä¾èµ–ã€PythonçŽ¯å¢ƒã€AIæœåŠ¡                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"

# æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®ç›®å½•
if [ ! -f "package.json" ]; then
    echo "âŒ é”™è¯¯: è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œæ­¤è„šæœ¬"
    echo "ðŸ’¡ æç¤º: è¯·ç¡®ä¿å½“å‰ç›®å½•åŒ…å«package.jsonæ–‡ä»¶"
    exit 1
fi

echo "ðŸ” æ£€æŸ¥ç³»ç»ŸçŽ¯å¢ƒ..."

# æ£€æŸ¥Node.js
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ“¦ ç¬¬ä¸€æ­¥: æ£€æŸ¥Node.jsçŽ¯å¢ƒ"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

if ! command -v node &> /dev/null; then
    echo "âŒ Node.jsæœªå®‰è£…"
    echo "ðŸ“¥ è¯·ä»Žä»¥ä¸‹åœ°å€ä¸‹è½½å®‰è£…Node.js 18æˆ–æ›´é«˜ç‰ˆæœ¬:"
    echo "   https://nodejs.org/zh-cn/download/"
    exit 1
else
    NODE_VERSION=$(node --version)
    echo "âœ… Node.jså·²å®‰è£…: $NODE_VERSION"
fi

if ! command -v npm &> /dev/null; then
    echo "âŒ npmæœªå®‰è£…"
    exit 1
else
    NPM_VERSION=$(npm --version)
    echo "âœ… npmå·²å®‰è£…: $NPM_VERSION"
fi

# æ£€æŸ¥Python
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ ç¬¬äºŒæ­¥: æ£€æŸ¥PythonçŽ¯å¢ƒ"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

if ! command -v python3 &> /dev/null; then
    echo "âŒ Python3æœªå®‰è£…"
    echo "ðŸ“¥ è¯·å®‰è£…Python 3.8æˆ–æ›´é«˜ç‰ˆæœ¬"
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "   macOS: brew install python3"
    else
        echo "   Ubuntu/Debian: sudo apt update && sudo apt install python3 python3-pip python3-venv"
        echo "   CentOS/RHEL: sudo yum install python3 python3-pip"
    fi
    exit 1
else
    PYTHON_VERSION=$(python3 --version)
    echo "âœ… Pythonå·²å®‰è£…: $PYTHON_VERSION"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ“¦ ç¬¬ä¸‰æ­¥: å®‰è£…å‰ç«¯ä¾èµ–"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ”„ æ­£åœ¨å®‰è£…Node.jsä¾èµ–..."
echo "ðŸ’¡ è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…..."

if ! npm install; then
    echo "âŒ npm installå¤±è´¥"
    echo "ðŸ’¡ å°è¯•æ¸…ç†ç¼“å­˜åŽé‡æ–°å®‰è£…..."
    npm cache clean --force
    rm -rf node_modules package-lock.json
    if ! npm install; then
        echo "âŒ å‰ç«¯ä¾èµ–å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥"
        exit 1
    fi
fi
echo "âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ ç¬¬å››æ­¥: é…ç½®Pythonè™šæ‹ŸçŽ¯å¢ƒ"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒ
if [ ! -d ".venv" ]; then
    echo "ðŸ”„ åˆ›å»ºPythonè™šæ‹ŸçŽ¯å¢ƒ..."
    if ! python3 -m venv .venv; then
        echo "âŒ è™šæ‹ŸçŽ¯å¢ƒåˆ›å»ºå¤±è´¥"
        exit 1
    fi
    echo "âœ… è™šæ‹ŸçŽ¯å¢ƒåˆ›å»ºæˆåŠŸ"
else
    echo "âœ… è™šæ‹ŸçŽ¯å¢ƒå·²å­˜åœ¨"
fi

# æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒ
echo "ðŸ”„ æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒ..."
source .venv/bin/activate

# å‡çº§pip
echo "ðŸ”„ å‡çº§pip..."
python -m pip install --upgrade pip

# å®‰è£…Pythonä¾èµ–
echo "ðŸ”„ å®‰è£…Pythonä¾èµ–..."
echo "ðŸ’¡ è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œç‰¹åˆ«æ˜¯OpenCVç­‰å¤§åž‹åº“..."
if ! pip install -r requirements.txt; then
    echo "âŒ Pythonä¾èµ–å®‰è£…å¤±è´¥"
    echo "ðŸ’¡ å°è¯•ä½¿ç”¨å›½å†…é•œåƒæº..."
    if ! pip install -i https://pypi.tuna.tsinghua.edu.cn/simple/ -r requirements.txt; then
        echo "âŒ Pythonä¾èµ–å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥"
        exit 1
    fi
fi
echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ§ª ç¬¬äº”æ­¥: çŽ¯å¢ƒæµ‹è¯•"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ”„ æµ‹è¯•PythonçŽ¯å¢ƒ..."
if ! python python/test_env.py; then
    echo "âš ï¸ çŽ¯å¢ƒæµ‹è¯•å‘çŽ°é—®é¢˜ï¼Œä½†æ ¸å¿ƒåŠŸèƒ½å¯èƒ½ä»å¯æ­£å¸¸ä½¿ç”¨"
else
    echo "âœ… çŽ¯å¢ƒæµ‹è¯•é€šè¿‡"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ¤– ç¬¬å…­æ­¥: AIæœåŠ¡é…ç½®ï¼ˆå¯é€‰ï¼‰"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ðŸ’¡ AIæœåŠ¡é…ç½®æ˜¯å¯é€‰çš„ï¼Œå³ä½¿ä¸é…ç½®AIï¼Œç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½ä»å¯æ­£å¸¸ä½¿ç”¨"
echo ""
read -p "æ˜¯å¦è¦é…ç½®æœ¬åœ°AIæœåŠ¡ï¼Ÿ(y/n): " SETUP_AI

if [[ "$SETUP_AI" =~ ^[Yy]$ ]]; then
    echo ""
    echo "ðŸ” æ£€æŸ¥Ollamaå®‰è£…çŠ¶æ€..."
    if ! command -v ollama &> /dev/null; then
        echo "âŒ Ollamaæœªå®‰è£…"
        echo "ðŸ“¥ è¯·ä»Žä»¥ä¸‹åœ°å€ä¸‹è½½å®‰è£…Ollama:"
        echo "   https://ollama.ai/download"
        echo ""
        echo "å®‰è£…å®ŒæˆåŽè¯·ï¼š"
        echo "1. é‡æ–°è¿è¡Œæ­¤è„šæœ¬"
        echo "2. æˆ–æ‰‹åŠ¨æ‰§è¡Œ: ollama serve å’Œ ollama pull qwen2.5-vl:7b"
        echo ""
    else
        echo "âœ… Ollamaå·²å®‰è£…"
        echo ""
        echo "ðŸ”„ å¯åŠ¨OllamaæœåŠ¡..."
        ollama serve &
        OLLAMA_PID=$!
        sleep 5
        
        echo "ðŸ”„ ä¸‹è½½AIæ¨¡åž‹ qwen2.5-vl:7b..."
        echo "ðŸ’¡ è¿™æ˜¯ä¸€ä¸ªçº¦4GBçš„æ¨¡åž‹ï¼Œä¸‹è½½å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´..."
        if ! ollama pull qwen2.5-vl:7b; then
            echo "âš ï¸ æ¨¡åž‹ä¸‹è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜"
            echo "ðŸ’¡ å¯ä»¥ç¨åŽæ‰‹åŠ¨æ‰§è¡Œ: ollama pull qwen2.5-vl:7b"
        else
            echo "âœ… AIæ¨¡åž‹ä¸‹è½½å®Œæˆ"
        fi
        
        echo "ðŸ§ª è¿è¡ŒAIæœåŠ¡è¯Šæ–­..."
        if [ -f "diagnose_ollama.sh" ]; then
            chmod +x diagnose_ollama.sh
            ./diagnose_ollama.sh
        fi
        
        # åœæ­¢åŽå°Ollamaè¿›ç¨‹
        kill $OLLAMA_PID 2>/dev/null || true
    fi
else
    echo "â­ï¸ è·³è¿‡AIæœåŠ¡é…ç½®"
    echo "ðŸ’¡ ç³»ç»Ÿå°†ä½¿ç”¨åŽå¤‡å»ºè®®åŠŸèƒ½ï¼Œæ ¸å¿ƒåŠŸèƒ½ä¸å—å½±å“"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ“ ç¬¬ä¸ƒæ­¥: åˆ›å»ºé…ç½®æ–‡ä»¶"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# åˆ›å»º .env.local æ–‡ä»¶
if [ ! -f ".env.local" ]; then
    echo "ðŸ”„ åˆ›å»ºçŽ¯å¢ƒé…ç½®æ–‡ä»¶..."
    cat > .env.local << 'EOF'
# æ— äººæœºæ™ºèƒ½åˆ†æžå¹³å°é…ç½®æ–‡ä»¶

# AIæ¨¡åž‹é…ç½®
QWEN_BASE_URL=http://localhost:11434/v1
QWEN_MODEL=qwen2.5-vl:7b

# æ— äººæœºé…ç½®
DRONE_WEBSOCKET_URL=ws://localhost:8765

# APIé…ç½®
NEXT_PUBLIC_API_URL=http://localhost:3000/api

# å¯é€‰ï¼šé˜¿é‡Œäº‘AIæœåŠ¡
# DASHSCOPE_API_KEY=your_api_key_here
EOF
    echo "âœ… çŽ¯å¢ƒé…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
else
    echo "âœ… çŽ¯å¢ƒé…ç½®æ–‡ä»¶å·²å­˜åœ¨"
fi

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                        ðŸŽ‰ é…ç½®å®Œæˆï¼                        â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âœ… å‰ç«¯çŽ¯å¢ƒ: Node.js + npm ä¾èµ–å·²å®‰è£…"
echo "âœ… åŽç«¯çŽ¯å¢ƒ: Python è™šæ‹ŸçŽ¯å¢ƒå’Œä¾èµ–å·²é…ç½®"
echo "âœ… é…ç½®æ–‡ä»¶: .env.local å·²åˆ›å»º"
if [[ "$SETUP_AI" =~ ^[Yy]$ ]]; then
    echo "âœ… AIæœåŠ¡: Ollama å’Œæ¨¡åž‹å·²é…ç½®"
else
    echo "â­ï¸ AIæœåŠ¡: å·²è·³è¿‡ï¼ˆå¯ç¨åŽé…ç½®ï¼‰"
fi
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸš€ å¯åŠ¨é¡¹ç›®"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "çŽ°åœ¨ä½ å¯ä»¥å¯åŠ¨é¡¹ç›®äº†ï¼š"
echo ""
echo "ðŸ“± å¯åŠ¨å‰ç«¯:"
echo "   npm run dev"
echo ""
echo "ðŸ å¯åŠ¨åŽç«¯:"
echo "   source .venv/bin/activate"
echo "   python python/drone_backend.py"
echo ""
echo "ðŸ¤– å¦‚æžœé…ç½®äº†AIæœåŠ¡:"
echo "   ollama serve"
echo ""
echo "ðŸŒ å‰ç«¯è®¿é—®åœ°å€: http://localhost:3000"
echo "ðŸ“¡ åŽç«¯WebSocket: ws://localhost:8765"
echo "ðŸ§  AIæœåŠ¡åœ°å€: http://localhost:11434"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ“š é‡è¦æ–‡ä»¶"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ðŸ“– æ–°æ‰‹å…¥é—¨æŒ‡å—.md - è¯¦ç»†ä½¿ç”¨è¯´æ˜Ž"
echo "ðŸ”§ TROUBLESHOOTING.md - æ•…éšœæŽ’é™¤æŒ‡å—"
echo "ðŸ“„ README_CN.md - é¡¹ç›®è¯¦ç»†æ–‡æ¡£"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ’¡ ä¸‹ä¸€æ­¥å»ºè®®"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "1. é˜…è¯» 'æ–°æ‰‹å…¥é—¨æŒ‡å—.md' äº†è§£è¯¦ç»†ä½¿ç”¨æ–¹æ³•"
echo "2. å¯åŠ¨å‰ç«¯: npm run dev"
echo "3. å¯åŠ¨åŽç«¯: source .venv/bin/activate && python python/drone_backend.py"
echo "4. è¿žæŽ¥DJI Telloæ— äººæœºè¿›è¡Œæµ‹è¯•"
echo "5. å¦‚é‡é—®é¢˜ï¼ŒæŸ¥çœ‹ TROUBLESHOOTING.md"
echo ""

read -p "æ˜¯å¦çŽ°åœ¨å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨ï¼Ÿ(y/n): " START_NOW
if [[ "$START_NOW" =~ ^[Yy]$ ]]; then
    echo ""
    echo "ðŸš€ å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨..."
    echo "ðŸ’¡ è¯·åœ¨æ–°çš„ç»ˆç«¯çª—å£è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨åŽç«¯:"
    echo "   source .venv/bin/activate && python python/drone_backend.py"
    echo ""
    npm run dev
else
    echo ""
    echo "ðŸ‘‹ é…ç½®å®Œæˆï¼è¯·éšæ—¶è¿è¡Œ npm run dev å¯åŠ¨é¡¹ç›®"
fi

echo ""
echo "æ„Ÿè°¢ä½¿ç”¨æ— äººæœºæ™ºèƒ½åˆ†æžå¹³å°ï¼"